apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xapplications
  labels:
    provider: kubernetes
    service: application
spec:
  writeConnectionSecretsToNamespace: crossplane-system
  compositeTypeRef:
    apiVersion: platform.kofiray.net/v1alpha1
    kind: XApplication
  resources:
  - name: deployment
    base:
      apiVersion: kubernetes.crossplane.io/v1alpha1
      kind: Object
      spec:
        forProvider:
          manifest:
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              labels:
                app: placeholder
            spec:
              replicas: 2
              selector:
                matchLabels:
                  app: placeholder
              template:
                metadata:
                  labels:
                    app: placeholder
                  annotations:
                    signoz.io/scrape: "true"
                spec:
                  containers:
                  - name: app
                    image: nginx:1.21
                    ports:
                    - containerPort: 80
                    resources:
                      requests:
                        cpu: 100m
                        memory: 128Mi
                      limits:
                        cpu: 500m
                        memory: 512Mi
                    readinessProbe:
                      httpGet:
                        path: /
                        port: 80
                      initialDelaySeconds: 10
                      periodSeconds: 5
                    livenessProbe:
                      httpGet:
                        path: /
                        port: 80
                      initialDelaySeconds: 30
                      periodSeconds: 10
                    securityContext:
                      runAsNonRoot: true
                      runAsUser: 1001
                      allowPrivilegeEscalation: false
                      readOnlyRootFilesystem: true
                      capabilities:
                        drop:
                        - ALL
        providerConfigRef:
          name: kubernetes-provider
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: spec.forProvider.manifest.metadata.name
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: spec.forProvider.manifest.metadata.labels.app
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: spec.forProvider.manifest.spec.selector.matchLabels.app
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: spec.forProvider.manifest.spec.template.metadata.labels.app
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.namespace
      toFieldPath: spec.forProvider.manifest.metadata.namespace
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.image
      toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].image
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.replicas
      toFieldPath: spec.forProvider.manifest.spec.replicas
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.port
      toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].ports[0].containerPort
  - name: service
    base:
      apiVersion: kubernetes.crossplane.io/v1alpha1
      kind: Object
      spec:
        forProvider:
          manifest:
            apiVersion: v1
            kind: Service
            metadata:
              labels:
                app: placeholder
            spec:
              selector:
                app: placeholder
              ports:
              - port: 80
                targetPort: 80
                protocol: TCP
        providerConfigRef:
          name: kubernetes-provider
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: spec.forProvider.manifest.metadata.name
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: spec.forProvider.manifest.metadata.labels.app
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: spec.forProvider.manifest.spec.selector.app
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.namespace
      toFieldPath: spec.forProvider.manifest.metadata.namespace
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.port
      toFieldPath: spec.forProvider.manifest.spec.ports[0].targetPort
  - name: argocd-application
    base:
      apiVersion: kubernetes.crossplane.io/v1alpha1
      kind: Object
      spec:
        forProvider:
          manifest:
            apiVersion: argoproj.io/v1alpha1
            kind: Application
            metadata:
              namespace: argocd
            spec:
              project: default
              source:
                repoURL: https://github.com/kofiray/backstage-platform.git
                targetRevision: HEAD
                path: apps
              destination:
                server: https://kubernetes.default.svc
              syncPolicy:
                automated:
                  prune: true
                  selfHeal: true
        providerConfigRef:
          name: kubernetes-provider
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.name
      toFieldPath: spec.forProvider.manifest.metadata.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.gitRepo
      toFieldPath: spec.forProvider.manifest.spec.source.repoURL
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.gitPath
      toFieldPath: spec.forProvider.manifest.spec.source.path
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.namespace
      toFieldPath: spec.forProvider.manifest.spec.destination.namespace
---
apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  name: xapplications.platform.kofiray.net
spec:
  group: platform.kofiray.net
  names:
    kind: XApplication
    plural: xapplications
  claimNames:
    kind: Application
    plural: applications
  versions:
  - name: v1alpha1
    served: true
    referenceable: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              parameters:
                type: object
                properties:
                  namespace:
                    type: string
                  image:
                    type: string
                    default: "nginx:1.21"
                  replicas:
                    type: integer
                    default: 2
                  port:
                    type: integer
                    default: 80
                  gitRepo:
                    type: string
                    default: "https://github.com/kofiray/backstage-platform.git"
                  gitPath:
                    type: string
                    default: "apps"
                required:
                - namespace
            required:
            - parameters
          status:
            type: object
            properties:
              ready:
                type: boolean
